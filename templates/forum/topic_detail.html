{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}{{ topic.title }} — MiniForum{% endblock %}

{% block content %}
<div class="card mb-3">
    <div class="card-body">
        <h3>{{ topic.title }}</h3>
        <p class="text-muted">
            Категория: {{ topic.category.name }} |
            Автор: {{ topic.author.username }} |
            {{ topic.created_at|date:"d.m.Y H:i" }}
        </p>

        <p>{{ topic.content|linebreaks }}</p>

{% if topic.image %}
    <img src="{{ topic.image.url }}" class="img-fluid mt-2" style="max-height: 300px;">
{% endif %}
    </div>
</div>

<p>
    Лайки: {{ topic.total_likes }} |
    Просмотры: {{ topic.views }}
</p>

{% if user.is_authenticated %}
<form action="{% url 'like_topic' topic.id %}" method="post" style="display:inline;">
    {% csrf_token %}
    {% if user in topic.likes.all %}
    <button type="submit" class="btn btn-sm btn-danger">Убрать лайк</button>
    {% else %}
    <button type="submit" class="btn btn-sm btn-outline-primary">Лайкнуть ❤️</button>
    {% endif %}
</form>
{% endif %}

<h4>Комментарии</h4>

{% for post in posts %}
<div class="card mb-2">
    <div class="card-body">
        <strong>{{ post.author.username }}</strong> — {{ post.created_at|date:"d.m.Y H:i" }}
        <p>{{ post.content }}</p>
    </div>
</div>
{% empty %}
<p>Комментариев пока нет.</p>
{% endfor %}

{% if user.is_authenticated %}
<h5 class="mt-4">Добавить комментарий</h5>
<form method="post">
    {% csrf_token %}
    {{ form|crispy }}
    <button class="btn btn-primary">Отправить</button>
</form>
{% else %}
<p class="mt-3">Чтобы комментировать, <a href="{% url 'login' %}">войдите</a>.</p>
{% endif %}

{% endblock %}
